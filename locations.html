<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã— | å…¨é¤¨ãƒãƒƒãƒ—</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;600;700&family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root {
      --cream: #f5f0e8;
      --navy: #1a2744;
      --navy-light: #2a3a60;
      --gold: #c9a84c;
      --gold-light: #e8c96a;
      --text: #2c2c2c;
      --text-muted: #7a7a7a;
      --green: #2d7a4f;
      --green-light: #e8f5ee;
      --blue: #4a7da8;
      --blue-light: #e8f0f7;
      --orange: #d87a3f;
      --orange-light: #fef3eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background-color: var(--cream);
      font-family: 'Noto Sans JP', sans-serif;
      color: var(--text);
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* èƒŒæ™¯ãƒ†ã‚¯ã‚¹ãƒãƒ£ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at 20% 20%, rgba(201,168,76,0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(26,39,68,0.06) 0%, transparent 50%);
      pointer-events: none;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      width: 100%;
      background: var(--navy);
      padding: 20px 24px;
      box-shadow: 0 2px 12px rgba(26,39,68,0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-icon {
      font-size: 28px;
    }

    .header-text {
      flex: 1;
    }

    .header-title {
      font-family: 'Noto Serif JP', serif;
      font-size: 18px;
      color: var(--cream);
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--gold);
      letter-spacing: 0.08em;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      color: var(--cream);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: blink 2s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 48px;
      flex: 1;
    }

    /* èª¬æ˜ã‚«ãƒ¼ãƒ‰ */
    .info-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: 0 2px 16px rgba(26,39,68,0.08);
      border: 1px solid rgba(201,168,76,0.2);
    }

    .info-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-text {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.8;
    }

    /* ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .locations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    /* ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .location-card {
      background: white;
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 4px 20px rgba(26,39,68,0.1);
      border: 2px solid rgba(201,168,76,0.2);
      overflow: hidden;
      transition: all 0.25s;
      cursor: pointer;
      position: relative;
    }

    .location-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 28px rgba(26,39,68,0.15);
      border-color: var(--gold);
    }

    .location-card:active {
      transform: translateY(-2px);
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
    .location-status-bar {
      height: 6px;
      background: var(--gold);
      transition: background 0.3s;
    }

    .location-card.waiting .location-status-bar {
      background: var(--orange);
      animation: statusPulse 2s ease-in-out infinite;
    }

    .location-card.responding .location-status-bar {
      background: var(--blue);
    }

    @keyframes statusPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ã‚«ãƒ¼ãƒ‰æœ¬ä½“ */
    .location-body {
      padding: 24px;
    }

    .location-floor {
      display: inline-block;
      background: var(--navy);
      color: var(--gold);
      font-size: 10px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
      letter-spacing: 0.08em;
      margin-bottom: 12px;
    }

    .location-name {
      font-family: 'Noto Serif JP', serif;
      font-size: 18px;
      font-weight: 700;
      color: var(--navy);
      line-height: 1.5;
      margin-bottom: 16px;
      min-height: 54px;
    }

    .location-action {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      background: var(--navy);
      color: white;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .location-card:hover .location-action {
      background: var(--navy-light);
    }

    .location-card.waiting .location-action {
      background: var(--orange-light);
      color: var(--orange);
      cursor: default;
    }

    .location-card.responding .location-action {
      background: var(--blue-light);
      color: var(--blue);
      cursor: default;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
    }

    .status-icon {
      font-size: 16px;
    }

    /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .error-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 2px solid #ffc5c0;
      border-radius: 12px;
      padding: 16px 24px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      font-size: 14px;
      color: #c0392b;
      z-index: 1000;
      display: none;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    .error-toast.show {
      display: block;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(201,168,76,0.2);
      border-top-color: var(--gold);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .footer {
      width: 100%;
      text-align: center;
      padding: 24px;
      font-size: 11px;
      color: var(--text-muted);
      border-top: 1px solid rgba(0,0,0,0.06);
      margin-top: auto;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .locations-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <span class="header-icon">ğŸ“š</span>
      <div class="header-text">
        <div class="header-title">å›³æ›¸é¤¨ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—</div>
        <div class="header-subtitle">å ´æ‰€ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‘¼ã‚“ã§ãã ã•ã„</div>
      </div>
      <div class="live-badge">
        <div class="live-dot"></div>
        æ¥ç¶šä¸­
      </div>
    </div>
  </header>

  <main class="container">

    <div class="info-card">
      <div class="info-title">
        <span>ğŸ’¡</span>
        ã”åˆ©ç”¨æ–¹æ³•
      </div>
      <div class="info-text">
        ãŠå›°ã‚Šã®å ´æ‰€ã®ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ã‚¹ã‚¿ãƒƒãƒ•ã«é€£çµ¡ãŒå±Šãã¾ã™ã€‚<br>
        æœ¬ã®å ´æ‰€ãŒã‚ã‹ã‚‰ãªã„ã€è¤‡åˆæ©Ÿã®ä½¿ã„æ–¹ãªã©ã€ãŠæ°—è»½ã«ãŠå‘¼ã³ãã ã•ã„ã€‚
      </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div>å ´æ‰€æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <!-- ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§ -->
    <div class="locations-grid" id="locationsGrid" style="display:none;">
      <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
    </div>

  </main>

  <footer class="footer">Â© å›³æ›¸é¤¨ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—ã‚·ã‚¹ãƒ†ãƒ </footer>

  <!-- ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div class="error-toast" id="errorToast"></div>

  <script>
    // ========================================
    // âš ï¸ Firebaseè¨­å®šï¼ˆuser.htmlã¨åŒã˜å€¤ã‚’å…¥ã‚Œã‚‹ï¼‰
    // ========================================
  const firebaseConfig = {
    apiKey: "AIzaSyAPg799DO1y3aPWGz_aQb_aUaeP9aKzn2w",
    authDomain: "lib-staff.firebaseapp.com",
    databaseURL: "https://lib-staff-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "lib-staff",
    storageBucket: "lib-staff.firebasestorage.app",
    messagingSenderId: "860183118414",
    appId: "1:860183118414:web:2358730cd9c4acdc78b91f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let locations = {};
    let activeCalls = {};

    // åˆæœŸåŒ–
    async function init() {
      try {
        await loadLocations();
        listenToCalls();
        renderLocations();
      } catch (e) {
        showError('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        console.error(e);
      }
    }

    // å ´æ‰€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    async function loadLocations() {
      const snap = await db.ref('locations').get();
      if (snap.exists()) {
        locations = snap.val();
      } else {
        throw new Error('å ´æ‰€ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }

    // å‘¼ã³å‡ºã—çŠ¶æ…‹ã‚’ç›£è¦–
    function listenToCalls() {
      db.ref('calls').on('value', (snap) => {
        activeCalls = {};
        if (snap.exists()) {
          snap.forEach(child => {
            const call = child.val();
            if (call.status === 'waiting' || call.status === 'responding') {
              activeCalls[call.locationId] = call.status;
            }
          });
        }
        updateLocationStates();
      });
    }

    // ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    function renderLocations() {
      const grid = document.getElementById('locationsGrid');
      const loading = document.getElementById('loading');

      // ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éšæ•°é †ã«ã‚½ãƒ¼ãƒˆ
      const sortedLocations = Object.entries(locations).sort((a, b) => {
        return a[0].localeCompare(b[0]);
      });

      grid.innerHTML = sortedLocations.map(([id, loc]) => {
        const status = activeCalls[id] || 'ready';
        return createLocationCard(id, loc, status);
      }).join('');

      // ã‚«ãƒ¼ãƒ‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      sortedLocations.forEach(([id]) => {
        const card = document.getElementById(`card-${id}`);
        if (card) {
          card.addEventListener('click', () => handleLocationClick(id));
        }
      });

      loading.style.display = 'none';
      grid.style.display = 'grid';
    }

    // ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰HTMLç”Ÿæˆ
    function createLocationCard(id, location, status) {
      const statusClass = status === 'waiting' ? 'waiting' : status === 'responding' ? 'responding' : '';
      const statusText = status === 'waiting' 
        ? '<span class="status-badge"><span class="status-icon">â³</span>å¾…æ©Ÿä¸­</span>'
        : status === 'responding'
        ? '<span class="status-badge"><span class="status-icon">ğŸƒ</span>å¯¾å¿œä¸­</span>'
        : '<span class="status-badge"><span class="status-icon">ğŸ””</span>ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‘¼ã¶</span>';

      return `
        <div class="location-card ${statusClass}" id="card-${id}" data-location="${id}">
          <div class="location-status-bar"></div>
          <div class="location-body">
            <div class="location-floor">${location.floor || id}</div>
            <div class="location-name">${location.name || id}</div>
            <div class="location-action">
              ${statusText}
            </div>
          </div>
        </div>
      `;
    }

    // ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    function updateLocationStates() {
      Object.entries(locations).forEach(([id, loc]) => {
        const card = document.getElementById(`card-${id}`);
        if (!card) return;

        const status = activeCalls[id] || 'ready';
        
        // ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
        card.className = `location-card ${status === 'waiting' ? 'waiting' : status === 'responding' ? 'responding' : ''}`;

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
        const action = card.querySelector('.location-action');
        if (action) {
          if (status === 'waiting') {
            action.innerHTML = '<span class="status-badge"><span class="status-icon">â³</span>å¾…æ©Ÿä¸­</span>';
          } else if (status === 'responding') {
            action.innerHTML = '<span class="status-badge"><span class="status-icon">ğŸƒ</span>å¯¾å¿œä¸­</span>';
          } else {
            action.innerHTML = '<span class="status-badge"><span class="status-icon">ğŸ””</span>ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‘¼ã¶</span>';
          }
        }
      });
    }

    // ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    async function handleLocationClick(locationId) {
      const status = activeCalls[locationId];

      // æ—¢ã«å‘¼ã³å‡ºã—ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (status === 'waiting' || status === 'responding') {
        showError('ã“ã®ã‚³ãƒ¼ãƒŠãƒ¼ã¯æ—¢ã«å‘¼ã³å‡ºã—ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      // å‘¼ã³å‡ºã—ã‚’ä½œæˆ
      try {
        const callData = {
          locationId,
          status: 'waiting',
          createdAt: Date.now(),
          respondedAt: null,
          completedAt: null,
          staffId: null,
          staffName: null
        };

        await db.ref('calls').push(callData);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆã®ä»£ã‚ã‚Šã«è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰
        const card = document.getElementById(`card-${locationId}`);
        if (card) {
          card.style.animation = 'none';
          card.offsetHeight; // reflow
          card.style.animation = 'statusPulse 0.5s ease';
        }

      } catch (e) {
        showError('å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        console.error(e);
      }
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(msg) {
      const toast = document.getElementById('errorToast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
