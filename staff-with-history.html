<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ç”»é¢ | å›³æ›¸é¤¨å‘¼ã³å‡ºã—ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #0f1624;
      --surface: #19233a;
      --surface2: #1f2d48;
      --border: rgba(255,255,255,0.08);
      --gold: #e4b84a;
      --gold-dim: rgba(228,184,74,0.15);
      --green: #34c97a;
      --green-dim: rgba(52,201,122,0.12);
      --red: #e8554a;
      --red-dim: rgba(232,85,74,0.12);
      --blue: #4a9de8;
      --blue-dim: rgba(74,157,232,0.12);
      --text: #e8e4d8;
      --text-muted: #7a8ba0;
      --text-dim: #4a5568;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      font-family: 'Noto Sans JP', sans-serif;
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ â”€â”€â”€ */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at center, #1a2744 0%, #0f1624 70%);
    }

    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 48px 40px;
      width: 360px;
      text-align: center;
    }

    .login-logo { font-size: 40px; margin-bottom: 16px; }
    .login-title { font-family: 'Noto Serif JP', serif; font-size: 20px; color: var(--gold); margin-bottom: 6px; }
    .login-sub { font-size: 12px; color: var(--text-muted); margin-bottom: 32px; }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 14px;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    .login-input:focus { border-color: var(--gold); }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--gold);
      color: #1a1a1a;
      border: none;
      border-radius: 10px;
      font-family: 'Noto Serif JP', serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
      margin-top: 4px;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .login-error { font-size: 12px; color: var(--red); margin-top: 12px; min-height: 18px; }
    .login-hint { font-size: 11px; color: var(--text-dim); margin-top: 16px; line-height: 1.6; }

    /* â”€â”€â”€ ã‚¢ãƒ—ãƒªæœ¬ä½“ â”€â”€â”€ */
    #app { display: none; }

    .layout { display: flex; min-height: 100vh; }

    /* â”€â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼ â”€â”€â”€ */
    .sidebar {
      width: 240px;
      min-height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 24px 0;
      position: fixed;
      top: 0; left: 0; bottom: 0;
    }

    .sidebar-logo { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .sidebar-logo-icon { font-size: 28px; margin-bottom: 8px; display: block; }
    .sidebar-logo-name { font-family: 'Noto Serif JP', serif; font-size: 15px; color: var(--gold); }
    .sidebar-logo-sub { font-size: 10px; color: var(--text-muted); letter-spacing: 0.08em; }

    .sidebar-nav { padding: 0 12px; flex: 1; }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 2px;
    }
    .nav-item.active { background: var(--gold-dim); color: var(--gold); }
    .nav-item:hover:not(.active) { background: rgba(255,255,255,0.03); }

    .sidebar-bottom { padding: 0 24px 16px; border-top: 1px solid var(--border); padding-top: 16px; }
    .staff-info { font-size: 12px; color: var(--text-muted); margin-bottom: 12px; }
    .staff-name-badge { display: inline-block; background: var(--gold-dim); color: var(--gold); padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }

    .logout-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--text-muted);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
      transition: all 0.2s;
    }
    .logout-btn:hover { border-color: var(--red); color: var(--red); }

    /* â”€â”€â”€ ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ â”€â”€â”€ */
    .main { margin-left: 240px; flex: 1; padding: 32px; }

    .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; }
    .page-title { font-family: 'Noto Serif JP', serif; font-size: 22px; color: var(--text); }

    .live-indicator { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--green); }
    .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: blink 2s ease-in-out infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

    /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
    .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px; }
    .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
    .summary-label { font-size: 11px; color: var(--text-muted); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 10px; }
    .summary-value { font-family: 'Noto Serif JP', serif; font-size: 36px; font-weight: 700; }
    .summary-card.waiting .summary-value { color: var(--gold); }
    .summary-card.responding .summary-value { color: var(--blue); }
    .summary-card.completed .summary-value { color: var(--green); }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .section { margin-bottom: 28px; }
    .section-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
    .section-title { font-size: 14px; font-weight: 700; letter-spacing: 0.05em; }
    .section-badge { padding: 2px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .badge-waiting { background: var(--gold-dim); color: var(--gold); }
    .badge-responding { background: var(--blue-dim); color: var(--blue); }
    .badge-completed { background: var(--green-dim); color: var(--green); }

    /* å‘¼ã³å‡ºã—ã‚«ãƒ¼ãƒ‰ */
    .call-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 24px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 20px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .call-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
    .call-card.waiting::before { background: var(--gold); }
    .call-card.responding::before { background: var(--blue); }
    .call-card.completed::before { background: var(--green); }
    .call-card.waiting { border-color: rgba(228,184,74,0.2); animation: cardPulse 3s ease-in-out infinite; }
    @keyframes cardPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(228,184,74,0); } 50% { box-shadow: 0 0 12px 2px rgba(228,184,74,0.1); } }

    .call-icon {
      width: 48px; height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }
    .call-card.waiting .call-icon { background: var(--gold-dim); }
    .call-card.responding .call-icon { background: var(--blue-dim); }
    .call-card.completed .call-icon { background: var(--green-dim); }

    .call-info { flex: 1; }
    .call-location { font-family: 'Noto Serif JP', serif; font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .call-meta { font-size: 12px; color: var(--text-muted); }
    .call-elapsed { font-size: 13px; font-weight: 500; margin-right: 12px; }
    .elapsed-warning { color: var(--red); }

    .call-actions { display: flex; gap: 8px; }

    .btn {
      padding: 9px 18px;
      border: none;
      border-radius: 9px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.04em;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn-respond { background: var(--blue); color: white; }
    .btn-respond:hover { opacity: 0.85; transform: scale(1.02); }
    .btn-complete { background: var(--green); color: white; }
    .btn-complete:hover { opacity: 0.85; transform: scale(1.02); }
    .btn-cancel { background: var(--surface2); color: var(--text-muted); border: 1px solid var(--border); }
    .btn-cancel:hover { border-color: var(--red); color: var(--red); }

    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-dim); font-size: 14px; }
    .completed-list { max-height: 320px; overflow-y: auto; }

    /* â”€â”€â”€ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é€šçŸ¥ â”€â”€â”€ */
    #alertPopup {
      position: fixed;
      top: 24px; right: 24px;
      width: 320px;
      background: var(--surface2);
      border: 1px solid var(--gold);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 1000;
      animation: slideIn 0.3s ease both;
      display: none;
    }
    @keyframes slideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }

    .popup-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .popup-dot { width: 10px; height: 10px; background: var(--gold); border-radius: 50%; animation: blink 1s ease-in-out infinite; }
    .popup-title { font-family: 'Noto Serif JP', serif; font-size: 15px; color: var(--gold); }
    .popup-location { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
    .popup-time { font-size: 11px; color: var(--text-muted); margin-bottom: 16px; }
    .popup-btns { display: flex; gap: 8px; }
    .popup-respond { flex: 1; padding: 10px; background: var(--gold); color: #1a1a1a; border: none; border-radius: 9px; font-family: 'Noto Serif JP', serif; font-size: 13px; font-weight: 700; cursor: pointer; }
    .popup-dismiss { padding: 10px 14px; background: none; border: 1px solid var(--border); border-radius: 9px; color: var(--text-muted); font-family: 'Noto Sans JP', sans-serif; font-size: 12px; cursor: pointer; }

    .sound-toggle {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .sound-toggle.on { border-color: var(--green); color: var(--green); }

    /* â”€â”€â”€ å±¥æ­´ç”»é¢ â”€â”€â”€ */
    #historyView { display: none; }

    .filter-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .filter-select, .filter-input {
      padding: 10px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 13px;
      outline: none;
    }

    .filter-select:focus, .filter-input:focus { border-color: var(--gold); }

    .export-btns {
      display: flex;
      gap: 8px;
      margin-left: auto;
    }

    .btn-export {
      padding: 10px 20px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 9px;
      font-family: 'Noto Sans JP', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-export:hover { opacity: 0.85; transform: scale(1.02); }
    .btn-export.excel { background: var(--blue); }

    /* å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« */
    .history-table-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table thead {
      background: var(--surface2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .history-table th {
      padding: 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: color 0.2s;
    }

    .history-table th:hover { color: var(--gold); }

    .history-table th.sortable::after {
      content: ' â†•';
      opacity: 0.3;
    }

    .history-table th.sort-asc::after {
      content: ' â†‘';
      opacity: 1;
      color: var(--gold);
    }

    .history-table th.sort-desc::after {
      content: ' â†“';
      opacity: 1;
      color: var(--gold);
    }

    .history-table td {
      padding: 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .history-table tbody tr:hover {
      background: rgba(255,255,255,0.02);
    }

    .status-chip {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-chip.completed { background: var(--green-dim); color: var(--green); }
    .status-chip.cancelled { background: var(--red-dim); color: var(--red); }

    .history-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-family: 'Noto Serif JP', serif;
      font-size: 32px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  </style>
</head>
<body>

  <!-- â”€â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ â”€â”€â”€ -->
  <div id="loginScreen">
    <div class="login-box">
      <span class="login-logo">ğŸ“š</span>
      <div class="login-title">å›³æ›¸é¤¨ã‚¹ã‚¿ãƒƒãƒ•ã‚·ã‚¹ãƒ†ãƒ </div>
      <div class="login-sub">STAFF CALL MANAGEMENT</div>
      <input class="login-input" type="text" id="loginStaffId" placeholder="ã‚¹ã‚¿ãƒƒãƒ•IDï¼ˆä¾‹: tanakaï¼‰" maxlength="20">
      <input class="login-input" type="password" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
             onkeydown="if(event.key==='Enter')doLogin()">
      <button class="login-btn" id="loginBtn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="login-error" id="loginError"></div>
      <div class="login-hint">
        ğŸ’¡ ã‚¹ã‚¿ãƒƒãƒ•IDã¯ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„<br>
        åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯è‡ªå‹•ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¾ã™
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ ã‚¢ãƒ—ãƒªæœ¬ä½“ â”€â”€â”€ -->
  <div id="app">
    <div class="layout">

      <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
      <aside class="sidebar">
        <div class="sidebar-logo">
          <span class="sidebar-logo-icon">ğŸ“š</span>
          <div class="sidebar-logo-name">å›³æ›¸é¤¨</div>
          <div class="sidebar-logo-sub">STAFF DASHBOARD</div>
        </div>
        <nav class="sidebar-nav">
          <div class="nav-item active" id="navDashboard" onclick="switchTab('dashboard')">ğŸ”” å‘¼ã³å‡ºã—ç®¡ç†</div>
          <div class="nav-item" id="navHistory" onclick="switchTab('history')">ğŸ“‹ å±¥æ­´ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        </nav>
        <div class="sidebar-bottom">
          <div class="staff-info">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
          <div class="staff-name-badge" id="currentStaffBadge">--</div>
          <button class="logout-btn" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </aside>

      <!-- ãƒ¡ã‚¤ãƒ³ -->
      <main class="main">
        
        <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ“ãƒ¥ãƒ¼ -->
        <div id="dashboardView">
          <div class="topbar">
            <h1 class="page-title">å‘¼ã³å‡ºã—ç®¡ç†</h1>
            <div style="display:flex;gap:12px;align-items:center">
              <button class="sound-toggle on" id="soundToggle" onclick="toggleSound()">
                ğŸ”” é€šçŸ¥éŸ³ ON
              </button>
              <div class="live-indicator">
                <div class="live-dot"></div>
                ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šä¸­
              </div>
            </div>
          </div>

          <!-- ã‚µãƒãƒªãƒ¼ -->
          <div class="summary-grid">
            <div class="summary-card waiting">
              <div class="summary-label">âš  å¾…æ©Ÿä¸­</div>
              <div class="summary-value" id="countWaiting">0</div>
            </div>
            <div class="summary-card responding">
              <div class="summary-label">ğŸƒ å¯¾å¿œä¸­</div>
              <div class="summary-value" id="countResponding">0</div>
            </div>
            <div class="summary-card completed">
              <div class="summary-label">âœ… æœ¬æ—¥å®Œäº†</div>
              <div class="summary-value" id="countCompleted">0</div>
            </div>
          </div>

          <!-- å¾…æ©Ÿä¸­ -->
          <div class="section">
            <div class="section-header">
              <span class="section-title" style="color:var(--gold)">âš  å¾…æ©Ÿä¸­</span>
              <span class="section-badge badge-waiting" id="badgeWaiting">0ä»¶</span>
            </div>
            <div id="listWaiting">
              <div class="empty-state">å¾…æ©Ÿä¸­ã®å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </div>

          <!-- å¯¾å¿œä¸­ -->
          <div class="section">
            <div class="section-header">
              <span class="section-title" style="color:var(--blue)">ğŸƒ å¯¾å¿œä¸­</span>
              <span class="section-badge badge-responding" id="badgeResponding">0ä»¶</span>
            </div>
            <div id="listResponding">
              <div class="empty-state">å¯¾å¿œä¸­ã®å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </div>

          <!-- å®Œäº†æ¸ˆã¿ï¼ˆæœ¬æ—¥ï¼‰ -->
          <div class="section">
            <div class="section-header">
              <span class="section-title" style="color:var(--text-muted)">âœ… æœ¬æ—¥ã®å®Œäº†æ¸ˆã¿</span>
              <span class="section-badge badge-completed" id="badgeCompleted">0ä»¶</span>
            </div>
            <div class="completed-list" id="listCompleted">
              <div class="empty-state">å®Œäº†æ¸ˆã¿ã®å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </div>
        </div>

        <!-- å±¥æ­´ãƒ“ãƒ¥ãƒ¼ -->
        <div id="historyView">
          <div class="topbar">
            <h1 class="page-title">å‘¼ã³å‡ºã—å±¥æ­´</h1>
          </div>

          <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
          <div class="history-stats">
            <div class="stat-card">
              <div class="stat-value" id="statTotal">0</div>
              <div class="stat-label">ç·å‘¼ã³å‡ºã—æ•°</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statCompleted">0</div>
              <div class="stat-label">å®Œäº†</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statCancelled">0</div>
              <div class="stat-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statAvgTime">--</div>
              <div class="stat-label">å¹³å‡å¿œç­”æ™‚é–“</div>
            </div>
          </div>

          <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
          <div class="filter-bar">
            <div class="filter-group">
              <label class="filter-label">æœŸé–“</label>
              <select class="filter-select" id="filterPeriod" onchange="filterHistory()">
                <option value="today">ä»Šæ—¥</option>
                <option value="week">ä»Šé€±</option>
                <option value="month">ä»Šæœˆ</option>
                <option value="all">å…¨æœŸé–“</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label class="filter-label">å ´æ‰€</label>
              <select class="filter-select" id="filterLocation" onchange="filterHistory()">
                <option value="all">ã™ã¹ã¦</option>
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select class="filter-select" id="filterStatus" onchange="filterHistory()">
                <option value="all">ã™ã¹ã¦</option>
                <option value="completed">å®Œäº†</option>
                <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>

            <div class="export-btns">
              <button class="btn-export" onclick="exportCSV()">
                ğŸ“„ CSVå‡ºåŠ›
              </button>
              <button class="btn-export excel" onclick="exportExcel()">
                ğŸ“Š Excelå‡ºåŠ›
              </button>
            </div>
          </div>

          <!-- å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
          <div class="history-table-container">
            <table class="history-table">
              <thead>
                <tr>
                  <th class="sortable" onclick="sortHistory('createdAt')">å‘¼ã³å‡ºã—æ—¥æ™‚</th>
                  <th class="sortable" onclick="sortHistory('location')">å ´æ‰€</th>
                  <th class="sortable" onclick="sortHistory('status')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th class="sortable" onclick="sortHistory('staff')">å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•</th>
                  <th class="sortable" onclick="sortHistory('responseTime')">å¿œç­”æ™‚é–“</th>
                  <th class="sortable" onclick="sortHistory('totalTime')">å¯¾å¿œæ™‚é–“</th>
                </tr>
              </thead>
              <tbody id="historyTableBody">
                <tr>
                  <td colspan="6" class="empty-state">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- â”€â”€â”€ å‘¼ã³å‡ºã—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— â”€â”€â”€ -->
  <div id="alertPopup">
    <div class="popup-header">
      <div class="popup-dot"></div>
      <div class="popup-title">ğŸ”” æ–°ã—ã„å‘¼ã³å‡ºã—</div>
    </div>
    <div class="popup-location" id="popupLocation">-</div>
    <div class="popup-time" id="popupTime">-</div>
    <div class="popup-btns">
      <button class="popup-respond" onclick="respondFromPopup()">ä»Šè¡Œãã¾ã™ï¼</button>
      <button class="popup-dismiss" onclick="dismissPopup()">å¾Œã§</button>
    </div>
  </div>

  <script>
    // ========================================
    // âš ï¸ Firebaseè¨­å®šï¼ˆuser.htmlã¨åŒã˜å€¤ã‚’å…¥ã‚Œã‚‹ï¼‰
    // ========================================
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // â”€â”€â”€ çŠ¶æ…‹ç®¡ç† â”€â”€â”€ 
    let currentStaff = null;
    let locations = {};
    let allCalls = {};
    let historyData = [];
    let filteredHistory = [];
    let soundEnabled = true;
    let popupCallId = null;
    let currentSortField = 'createdAt';
    let currentSortOrder = 'desc';

    // â”€â”€â”€ èªè¨¼çŠ¶æ…‹ã®ç›£è¦– â”€â”€â”€ 
    auth.onAuthStateChanged((user) => {
      if (user) {
        const staffId = user.email.split('@')[0];
        currentStaff = { id: user.uid, name: staffId };
        document.getElementById('currentStaffBadge').textContent = staffId;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';

        db.ref(`activeStaff/${user.uid}`).set({ name: staffId, lastActive: Date.now() });
        db.ref(`activeStaff/${user.uid}`).onDisconnect().remove();

        loadLocations();
        listenCalls();
        loadHistory();
        requestNotificationPermission();
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('app').style.display = 'none';
      }
    });

    // â”€â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ â”€â”€â”€ 
    async function doLogin() {
      const staffId = document.getElementById('loginStaffId').value.trim();
      const pass = document.getElementById('loginPass').value;
      const loginBtn = document.getElementById('loginBtn');

      if (!staffId) { showLoginError('ã‚¹ã‚¿ãƒƒãƒ•IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (!pass) { showLoginError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const email = `${staffId}@library.local`;
      loginBtn.disabled = true;
      loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';

      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch (error) {
        console.error(error);
        loginBtn.disabled = false;
        loginBtn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';

        if (error.code === 'auth/user-not-found') {
          showLoginError('ã‚¹ã‚¿ãƒƒãƒ•IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        } else if (error.code === 'auth/wrong-password') {
          showLoginError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
        } else if (error.code === 'auth/invalid-email') {
          showLoginError('ã‚¹ã‚¿ãƒƒãƒ•IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        } else {
          showLoginError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
      }
    }

    function doLogout() {
      if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
      if (currentStaff) {
        db.ref(`activeStaff/${currentStaff.id}`).remove();
        db.ref('calls').off();
      }
      auth.signOut();
      currentStaff = null;
      document.getElementById('loginStaffId').value = '';
      document.getElementById('loginPass').value = '';
    }

    function showLoginError(msg) {
      document.getElementById('loginError').textContent = msg;
      setTimeout(() => { document.getElementById('loginError').textContent = ''; }, 5000);
    }

    // â”€â”€â”€ å ´æ‰€ãƒã‚¹ã‚¿èª­ã¿è¾¼ã¿ â”€â”€â”€ 
    async function loadLocations() {
      const snap = await db.ref('locations').get();
      if (snap.exists()) {
        locations = snap.val();
        populateLocationFilter();
      }
    }

    function getLocationName(locationId) {
      return locations[locationId]?.name || locationId;
    }

    function populateLocationFilter() {
      const select = document.getElementById('filterLocation');
      Object.entries(locations).forEach(([id, loc]) => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = loc.name || id;
        select.appendChild(option);
      });
    }

    // â”€â”€â”€ å‘¼ã³å‡ºã—ç›£è¦–ï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ï¼‰ â”€â”€â”€ 
    function listenCalls() {
      const todayStart = new Date();
      todayStart.setHours(0,0,0,0);

      db.ref('calls').orderByChild('createdAt')
        .startAt(todayStart.getTime())
        .on('value', (snap) => {
          allCalls = {};
          if (snap.exists()) {
            snap.forEach(child => {
              allCalls[child.key] = { id: child.key, ...child.val() };
            });
          }
          renderCalls();
        });

      db.ref('calls').orderByChild('status').equalTo('waiting')
        .on('child_added', (snap) => {
          const call = snap.val();
          if (!call || Date.now() - call.createdAt > 5000) return;
          showPopup(snap.key, call);
          playNotificationSound();
          showBrowserNotification(call);
        });
    }

    // â”€â”€â”€ ç”»é¢æç”» â”€â”€â”€ 
    function renderCalls() {
      const waiting = Object.values(allCalls).filter(c => c.status === 'waiting');
      const responding = Object.values(allCalls).filter(c => c.status === 'responding');
      const completed = Object.values(allCalls).filter(c => c.status === 'completed')
                          .sort((a,b) => b.completedAt - a.completedAt);

      document.getElementById('countWaiting').textContent = waiting.length;
      document.getElementById('countResponding').textContent = responding.length;
      document.getElementById('countCompleted').textContent = completed.length;
      document.getElementById('badgeWaiting').textContent = `${waiting.length}ä»¶`;
      document.getElementById('badgeResponding').textContent = `${responding.length}ä»¶`;
      document.getElementById('badgeCompleted').textContent = `${completed.length}ä»¶`;

      const waitingEl = document.getElementById('listWaiting');
      if (waiting.length === 0) {
        waitingEl.innerHTML = '<div class="empty-state">å¾…æ©Ÿä¸­ã®å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“ âœ¨</div>';
      } else {
        waitingEl.innerHTML = waiting.map(c => renderWaitingCard(c)).join('');
      }

      const respondingEl = document.getElementById('listResponding');
      if (responding.length === 0) {
        respondingEl.innerHTML = '<div class="empty-state">å¯¾å¿œä¸­ã®å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        respondingEl.innerHTML = responding.map(c => renderRespondingCard(c)).join('');
      }

      const completedEl = document.getElementById('listCompleted');
      if (completed.length === 0) {
        completedEl.innerHTML = '<div class="empty-state">å®Œäº†æ¸ˆã¿ã®å‘¼ã³å‡ºã—ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        completedEl.innerHTML = completed.slice(0,10).map(c => renderCompletedCard(c)).join('');
      }

      updateElapsedTimers();
    }

    function renderWaitingCard(call) {
      const elapsed = formatElapsed(call.createdAt);
      const isLong = (Date.now() - call.createdAt) > 3 * 60 * 1000;
      return `
        <div class="call-card waiting" id="card-${call.id}">
          <div class="call-icon">ğŸ””</div>
          <div class="call-info">
            <div class="call-location">${getLocationName(call.locationId)}</div>
            <div class="call-meta">
              <span class="call-elapsed ${isLong ? 'elapsed-warning' : ''}" id="elapsed-${call.id}">
                ${isLong ? 'âš  ' : ''}å¾…æ©Ÿ ${elapsed}
              </span>
              ${formatTime(call.createdAt)}
            </div>
          </div>
          <div class="call-actions">
            <button class="btn btn-respond" onclick="respondCall('${call.id}')">ä»Šè¡Œãã¾ã™</button>
            <button class="btn btn-cancel" onclick="cancelCall('${call.id}')">å–æ¶ˆ</button>
          </div>
        </div>`;
    }

    function renderRespondingCard(call) {
      return `
        <div class="call-card responding">
          <div class="call-icon">ğŸƒ</div>
          <div class="call-info">
            <div class="call-location">${getLocationName(call.locationId)}</div>
            <div class="call-meta">æ‹…å½“: ${call.staffName || 'æœªè¨­å®š'} ï¼ ${formatTime(call.respondedAt)}</div>
          </div>
          <div class="call-actions">
            <button class="btn btn-complete" onclick="completeCall('${call.id}')">å¯¾å¿œå®Œäº†</button>
          </div>
        </div>`;
    }

    function renderCompletedCard(call) {
      const respSec = call.respondedAt && call.createdAt
        ? Math.floor((call.respondedAt - call.createdAt) / 1000) : null;
      return `
        <div class="call-card completed">
          <div class="call-icon">âœ…</div>
          <div class="call-info">
            <div class="call-location">${getLocationName(call.locationId)}</div>
            <div class="call-meta">
              ${call.staffName || '-'} ï¼ ${formatTime(call.completedAt)}
              ${respSec !== null ? ` ï¼ å¿œç­”: ${respSec}ç§’` : ''}
            </div>
          </div>
        </div>`;
    }

    function updateElapsedTimers() {
      Object.values(allCalls).forEach(c => {
        if (c.status !== 'waiting') return;
        const el = document.getElementById(`elapsed-${c.id}`);
        if (!el) return;
        const elapsed = formatElapsed(c.createdAt);
        const isLong = (Date.now() - c.createdAt) > 3 * 60 * 1000;
        el.className = `call-elapsed ${isLong ? 'elapsed-warning' : ''}`;
        el.textContent = `${isLong ? 'âš  ' : ''}å¾…æ©Ÿ ${elapsed}`;
      });
    }

    setInterval(updateElapsedTimers, 10000);

    // â”€â”€â”€ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ â”€â”€â”€ 
    async function respondCall(callId, fromPopup = false) {
      try {
        await db.ref(`calls/${callId}`).update({
          status: 'responding',
          respondedAt: Date.now(),
          staffId: currentStaff.id,
          staffName: currentStaff.name
        });
        if (fromPopup) dismissPopup();
      } catch(e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    }

    async function completeCall(callId) {
      try {
        await db.ref(`calls/${callId}`).update({
          status: 'completed',
          completedAt: Date.now()
        });
      } catch(e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    }

    async function cancelCall(callId) {
      if (!confirm('ã“ã®å‘¼ã³å‡ºã—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        await db.ref(`calls/${callId}`).update({
          status: 'cancelled',
          completedAt: Date.now()
        });
      } catch(e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    }

    // â”€â”€â”€ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— â”€â”€â”€ 
    function showPopup(callId, call) {
      popupCallId = callId;
      document.getElementById('popupLocation').textContent = getLocationName(call.locationId);
      document.getElementById('popupTime').textContent = `å‘¼ã³å‡ºã—æ™‚åˆ»: ${formatTime(call.createdAt)}`;
      const popup = document.getElementById('alertPopup');
      popup.style.display = 'block';
      popup.style.animation = 'none';
      popup.offsetHeight;
      popup.style.animation = '';
      setTimeout(() => { if (popup.style.display === 'block') dismissPopup(); }, 30000);
    }

    function dismissPopup() {
      document.getElementById('alertPopup').style.display = 'none';
      popupCallId = null;
    }

    function respondFromPopup() {
      if (popupCallId) respondCall(popupCallId, true);
    }

    // â”€â”€â”€ é€šçŸ¥ â”€â”€â”€ 
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    function showBrowserNotification(call) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('ğŸ“š æ–°ã—ã„å‘¼ã³å‡ºã—', {
          body: getLocationName(call.locationId),
          icon: 'ğŸ“š'
        });
      }
    }

    function playNotificationSound() {
      if (!soundEnabled) return;
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        [880, 1100, 1320].forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.3, ctx.currentTime + i * 0.15);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.15 + 0.3);
          osc.start(ctx.currentTime + i * 0.15);
          osc.stop(ctx.currentTime + i * 0.15 + 0.3);
        });
      } catch (e) {}
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('soundToggle');
      btn.textContent = soundEnabled ? 'ğŸ”” é€šçŸ¥éŸ³ ON' : 'ğŸ”• é€šçŸ¥éŸ³ OFF';
      btn.className = `sound-toggle ${soundEnabled ? 'on' : ''}`;
    }

    // â”€â”€â”€ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ â”€â”€â”€ 
    function switchTab(tab) {
      document.getElementById('navDashboard').classList.toggle('active', tab === 'dashboard');
      document.getElementById('navHistory').classList.toggle('active', tab === 'history');
      document.getElementById('dashboardView').style.display = tab === 'dashboard' ? 'block' : 'none';
      document.getElementById('historyView').style.display = tab === 'history' ? 'block' : 'none';

      if (tab === 'history') {
        renderHistory();
      }
    }

    // â”€â”€â”€ å±¥æ­´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ â”€â”€â”€ 
    async function loadHistory() {
      const snap = await db.ref('calls').get();
      historyData = [];
      if (snap.exists()) {
        snap.forEach(child => {
          const call = child.val();
          if (call.status === 'completed' || call.status === 'cancelled') {
            historyData.push({ id: child.key, ...call });
          }
        });
      }
      filteredHistory = [...historyData];
    }

    // â”€â”€â”€ å±¥æ­´ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ â”€â”€â”€ 
    function filterHistory() {
      const period = document.getElementById('filterPeriod').value;
      const location = document.getElementById('filterLocation').value;
      const status = document.getElementById('filterStatus').value;

      const now = Date.now();
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const weekStart = new Date(); weekStart.setDate(weekStart.getDate() - 7);
      const monthStart = new Date(); monthStart.setMonth(monthStart.getMonth() - 1);

      filteredHistory = historyData.filter(call => {
        // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let passesTime = true;
        if (period === 'today') passesTime = call.createdAt >= todayStart.getTime();
        else if (period === 'week') passesTime = call.createdAt >= weekStart.getTime();
        else if (period === 'month') passesTime = call.createdAt >= monthStart.getTime();

        // å ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const passesLocation = location === 'all' || call.locationId === location;

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const passesStatus = status === 'all' || call.status === status;

        return passesTime && passesLocation && passesStatus;
      });

      renderHistory();
    }

    // â”€â”€â”€ å±¥æ­´ã‚½ãƒ¼ãƒˆ â”€â”€â”€ 
    function sortHistory(field) {
      if (currentSortField === field) {
        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        currentSortField = field;
        currentSortOrder = 'desc';
      }

      filteredHistory.sort((a, b) => {
        let aVal, bVal;

        if (field === 'createdAt') {
          aVal = a.createdAt;
          bVal = b.createdAt;
        } else if (field === 'location') {
          aVal = getLocationName(a.locationId);
          bVal = getLocationName(b.locationId);
        } else if (field === 'status') {
          aVal = a.status;
          bVal = b.status;
        } else if (field === 'staff') {
          aVal = a.staffName || '';
          bVal = b.staffName || '';
        } else if (field === 'responseTime') {
          aVal = (a.respondedAt && a.createdAt) ? (a.respondedAt - a.createdAt) : 999999999;
          bVal = (b.respondedAt && b.createdAt) ? (b.respondedAt - b.createdAt) : 999999999;
        } else if (field === 'totalTime') {
          aVal = (a.completedAt && a.createdAt) ? (a.completedAt - a.createdAt) : 999999999;
          bVal = (b.completedAt && b.createdAt) ? (b.completedAt - b.createdAt) : 999999999;
        }

        if (currentSortOrder === 'asc') {
          return aVal > bVal ? 1 : -1;
        } else {
          return aVal < bVal ? 1 : -1;
        }
      });

      renderHistory();
      updateSortIcons();
    }

    function updateSortIcons() {
      document.querySelectorAll('.history-table th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });

      const fieldMap = {
        'createdAt': 0,
        'location': 1,
        'status': 2,
        'staff': 3,
        'responseTime': 4,
        'totalTime': 5
      };

      const thIndex = fieldMap[currentSortField];
      if (thIndex !== undefined) {
        const th = document.querySelectorAll('.history-table th')[thIndex];
        th.classList.add(currentSortOrder === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    }

    // â”€â”€â”€ å±¥æ­´è¡¨ç¤º â”€â”€â”€ 
    function renderHistory() {
      const tbody = document.getElementById('historyTableBody');

      if (filteredHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      } else {
        tbody.innerHTML = filteredHistory.map(call => {
          const responseTime = (call.respondedAt && call.createdAt) 
            ? formatSeconds(Math.floor((call.respondedAt - call.createdAt) / 1000))
            : '-';
          
          const totalTime = (call.completedAt && call.createdAt)
            ? formatSeconds(Math.floor((call.completedAt - call.createdAt) / 1000))
            : '-';

          return `
            <tr>
              <td>${formatDateTime(call.createdAt)}</td>
              <td>${getLocationName(call.locationId)}</td>
              <td><span class="status-chip ${call.status}">${call.status === 'completed' ? 'å®Œäº†' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'}</span></td>
              <td>${call.staffName || '-'}</td>
              <td>${responseTime}</td>
              <td>${totalTime}</td>
            </tr>
          `;
        }).join('');
      }

      // çµ±è¨ˆã‚’æ›´æ–°
      updateHistoryStats();
    }

    // â”€â”€â”€ çµ±è¨ˆæ›´æ–° â”€â”€â”€ 
    function updateHistoryStats() {
      const total = filteredHistory.length;
      const completed = filteredHistory.filter(c => c.status === 'completed').length;
      const cancelled = filteredHistory.filter(c => c.status === 'cancelled').length;

      const responseTimes = filteredHistory
        .filter(c => c.respondedAt && c.createdAt)
        .map(c => c.respondedAt - c.createdAt);

      const avgTime = responseTimes.length > 0
        ? Math.floor(responseTimes.reduce((a,b) => a+b, 0) / responseTimes.length / 1000)
        : 0;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statCompleted').textContent = completed;
      document.getElementById('statCancelled').textContent = cancelled;
      document.getElementById('statAvgTime').textContent = avgTime > 0 ? formatSeconds(avgTime) : '--';
    }

    // â”€â”€â”€ CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â”€â”€â”€ 
    function exportCSV() {
      if (filteredHistory.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const headers = ['å‘¼ã³å‡ºã—æ—¥æ™‚', 'å ´æ‰€', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•', 'å¿œç­”æ™‚é–“(ç§’)', 'å¯¾å¿œæ™‚é–“(ç§’)'];
      const rows = filteredHistory.map(call => {
        const responseTime = (call.respondedAt && call.createdAt) 
          ? Math.floor((call.respondedAt - call.createdAt) / 1000) : '';
        const totalTime = (call.completedAt && call.createdAt)
          ? Math.floor((call.completedAt - call.createdAt) / 1000) : '';

        return [
          formatDateTime(call.createdAt),
          getLocationName(call.locationId),
          call.status === 'completed' ? 'å®Œäº†' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
          call.staffName || '',
          responseTime,
          totalTime
        ];
      });

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      const bom = '\uFEFF';
      const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `å‘¼ã³å‡ºã—å±¥æ­´_${formatDate(new Date())}.csv`;
      link.click();
    }

    // â”€â”€â”€ Excel ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â”€â”€â”€ 
    function exportExcel() {
      if (filteredHistory.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const headers = ['å‘¼ã³å‡ºã—æ—¥æ™‚', 'å ´æ‰€', 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', 'å¯¾å¿œã‚¹ã‚¿ãƒƒãƒ•', 'å¿œç­”æ™‚é–“(ç§’)', 'å¯¾å¿œæ™‚é–“(ç§’)'];
      const data = filteredHistory.map(call => {
        const responseTime = (call.respondedAt && call.createdAt) 
          ? Math.floor((call.respondedAt - call.createdAt) / 1000) : '';
        const totalTime = (call.completedAt && call.createdAt)
          ? Math.floor((call.completedAt - call.createdAt) / 1000) : '';

        return [
          formatDateTime(call.createdAt),
          getLocationName(call.locationId),
          call.status === 'completed' ? 'å®Œäº†' : 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
          call.staffName || '',
          responseTime,
          totalTime
        ];
      });

      const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'å‘¼ã³å‡ºã—å±¥æ­´');
      XLSX.writeFile(wb, `å‘¼ã³å‡ºã—å±¥æ­´_${formatDate(new Date())}.xlsx`);
    }

    // â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€â”€ 
    function formatTime(ts) {
      if (!ts) return '-';
      return new Date(ts).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    }

    function formatDateTime(ts) {
      if (!ts) return '-';
      const d = new Date(ts);
      return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function formatDate(d) {
      return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
    }

    function formatElapsed(ts) {
      const sec = Math.floor((Date.now() - ts) / 1000);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}åˆ†${String(s).padStart(2,'0')}ç§’`;
    }

    function formatSeconds(sec) {
      if (sec < 60) return `${sec}ç§’`;
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}åˆ†${s}ç§’`;
    }
  </script>
</body>
</html>
